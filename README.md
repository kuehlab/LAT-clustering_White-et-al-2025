# LAT Clustering Simulations
## Running the simulations
All simulations were run using `simulations/code/LAT_cluster_sim.py` with various settings. Jupyter notebooks were used to set up the parameters and commands to run each set of simulations, and scripts following the format of `simulations/code/submit.sh` were used to run those commands. The resulting simulation outputs were processed in the same Jupyter notebooks to produce summary files used for creating the figures. The Jupyter notebooks and associated summary files for each figure are included in the directories listed below:
- Figure 2,3 and Supplemental Figure S3A,B,C: `simulations/run_sims/single_TCR/`
- Figure 4B-F: `simulations/run_sims/kinetic_proofreading/`
- Figure 4G,H: `simulations/run_sims/dynamic_range/`
- Figure 5B,C: `simulations/run_sims/spacing/`
- Supplemental Figure S1: `simulations/run_sims/phase_separation/`
- Supplemental Figure S3D-F: `simulations/run_sims/alternate_parameters/`
- Supplemental Figure S9: `simulations/run_sims/diffusion/`
- Supplemental Figure S10: `simulations/run_sims/reaction_kinetics/`
## Rendering GIFs
All GIFs were rendered by using a `simulations/code/make_movie.py`. Jupyter notebooks were used to make a set of commands to run (the `make_movies.ipynb` file in each of the direectories listed above). The commands were executed using a script with the same format as `simulations/code/gif_submit.sh`. The raw simulation outputs used to create the GIFs are included in the directories above in sub-directories named `raw_trajectories/`.
## Plotting the figures
Figures were plotted using Jupyter notebooks and the summary files generated by the above notebooks. These notebooks are included in `simulations/plotting/` and are named based on the figure they were used to create. Additional data borrowed from McAffee et al. Nat. Commun. (2022) is included in `simulations/plotting/McAffee_data/`


# Image Analysis
## Running the pipeline
Image analysis was conducted using the MATLAB code provided in `image_analysis/` following these major steps:
1. Add all files in `image_analysis/code/utils/` to your MATLAB path
2. Create a directory with the following structure to hold the data and analysis results\
$\qquad$ `<experiment_name>/`\
$\qquad \qquad \qquad$ `raw_data/`\
$\qquad \qquad \qquad \qquad \qquad$ `<data_name1>/` (contains TIF files from microscope)\
$\qquad \qquad \qquad \qquad \qquad$ `<data_name1>.pos` (text file with list of image names in the order they are listed in `<data_name1>/`)\
$\qquad \qquad \qquad \qquad \qquad$ ...\
$\qquad \qquad \qquad \qquad \qquad$ `<data_nameN>/` (contains TIF files from microscope)\
$\qquad \qquad \qquad \qquad \qquad$ `<data_nameN>.pos`(text file with list of image names in the order they are listed in `<data_nameN>/`)
3. Copy all files in `image_analysis/code/main/` into the `<experiment_name>/` directory
4. Adjust the parameters in `makeparams_multiseg.m` as needed
	- `p.path` should be set to the `<experiment_name>/` directory
	- `p.basename` should be the prefix that all of your TIF files begin with (can be an empty string if there is no shared prefix). If multiple `data_name/` sub-directories are used, this should be a cell array with a prefix for each one, in the same order as they are listed in `p.pos_files` (below)
	- `p.pos_files` should be a cell array containing `data_name1` through `data_nameN`
	- `p.flatfield_correction` should be the path to the a file containing pixel-by pixel correction values for a flatfield correction. IF  this is not desired, omit this parameter entirely.
	- `p.im_X` and `p.im_Y` should be set to the dimensions of your image data (in pixels)
	- `p.channels` should be a cell array containing the desired names of each imaging channel used in the experiment, in the order the microscope collected them.
	- `p.channel_names` should be a cell array of the names the microscope uses for each channel, in the same order as `p.channels`
	- Note: each channel listed here can be segmented. To do this, create a set of parameters called `p.seg_<channel_name>.<param_name>` to describe the segmentation. Follow the format used in `image_analysis/code/main/makeparams_multiseg.m`
	- `p.time_names` should be a cell array of the row names used in your experiment (we used each row for a different time point, hence the name). These should match the first part of the names provided in the `.pos` files.
	- `p.density_names` should be a cell array of the column names used in your experiment (we used a different column for each pMHC density in the arrays, hence the name). These should match the second part of the names provided in the `.pos` files.
	- For example, if `p.time_names = {'A','B'}` and `p.density_names = {'10','12'}`, then names starting with A10, A12, B10, B12 will be included in analysis.
	- `p.omit` should be a cell array of the names of files (as they appear in the `.pos` files) to omit (i.e. because of imaging errors/artifacts)
	- `p.slices` should be a 1xN matrix listing the numbers of the z-slices to include in analysis
5. Run the updated `makeparams_multiseg.m` to produce a parameter file that will be read in by the image processing pipeline.
6. Edit lines 4 of `main_multiseg.m` to use the path to the `<experiment_name>/` directory
7. Run the first section of `main_multiseg.m` (this will take a while).
8. Use the `check_arrayseg.m` and `check_cellseg.m` files to adjust parameters in the makeparams file as needed. These files allow a single image to be processed at a time so that you can adjust parameters and check the results quickly.
9. Run the second section of `main_multiseg.m` (this will take a while).
10. Use the GUI to confirm that the resulting segmentations are satisfactory (see instructions below). If not, adjust parameters and repeat steps 9 and 10.
11. Run the third section of `main_multiseg.m` (this will take a while).
## Using the GUI to browse segmentations
1. Add all files in `image_analysis/code/GUI/` to your MATLAB path
2. Open the GUI app (run this command: `stack_viewer_multiseg_App`)
3. In the popup file browser, select an image from the `<p.out_prefix>_corrected_data` directory in your `<experiment_name>/` directory (this directory is automatically created in step 9 above).
4. Use the GUI to adjust the image contrast settings and examine the various channels and segnemtations using the top and left sections of the control panel for the app.
5. If desired, save images with segmentation outlines drawn over them using the right-hand side of the control panel.
## Making the figures
### Cell images
Images of whole cells (fig. 6B,C; large images) were created using the GUI to find and zoom in on representative cells.
### Array images
Images of arrays (fig. 6B,C; large images) were created using `image_analysis/plotting/example_zoomed_arrays.m` after following the steps in the "Running the pipeline" section above. The script was copied into the relevant `<experiment_name>/` directory prior to being run.
### Figure 6
Plots for figure 6 were generated through the following steps:
1. The `image_analysis/plotting/save_csvs.m` script was used to convert MATLAB data files to csvs. These data are included in `image_analysis/plotting/20230914_csvs/` and `image_analysis/plotting/20240201_csvs/`
2. Figure 6D,E were created with `image_analysis/plotting/fig6DE.ipynb`
3. Figre 6F-H were created with `image_analysis/plotting/fig6F-H.ipynb`
### Supplemental figures S4-8
Figures were plotted using Jupyter notebooks and the summary files generated by the above notebooks. These notebooks are included in `image_analysis/plotting/` and are named based on the figure they were used to create. The data used to generate the plots are also oncluded in the same folder. Note that a file generated by `fig6F-H.ipynb` is necessary to run `figS8.ipynb`.
